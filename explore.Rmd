---
title: "explore"
author: "Jake Eisaguirre"
date: "6/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(janitor)
library(sf)
library(lubridate)
library(leaflet)
library(sp)
library(RPostgreSQL)
library(rstudioapi)
library(DBI)
library(RPostgres)
```

# postres download
```{r}

dsn_database = ""   # Specify the name of your Database
# Specify host name e.g.:"aws-us-east-1-portal.4.dblayer.com"
dsn_hostname = ""  
dsn_port = ""                # Specify your port number. e.g. 98939
dsn_uid = ""         # Specify your username. e.g. "admin"
dsn_pwd =         # Specify your password. e.g. "xxx"


tryCatch({
    drv <- dbDriver("PostgreSQL")
    print("Connecting to Databaseâ€¦")
    connec <- dbConnect(drv, 
                 dbname = dsn_database,
                 host = dsn_hostname, 
                 port = dsn_port,
                 user = dsn_uid, 
                 password = dsn_pwd)
    print("Database Connected!")
    },
    error=function(cond) {
            print("Unable to connect to Database.")
    })


con = dbConnect(dbDriver(""),
                host = "",
                port = "",
                dbname = "",
                user = "",
                password = "")

```
```{r}
t <- data %>%
            dplyr::filter(date >= 2020, date <= 2021, wilderness == "kings_canyon", 
                          species == "ramu", visual_life_stage == "adult")
```


# VES data
```{r}
ves_data <- read_csv(here("data", "ves.csv")) %>% 
  clean_names()

clean_ves_data <- ves_data %>% 
  dplyr::select(c(id_1, utme, utmn, wilderness, visit_date, species, visual_life_stage, 
                  visual_animal_state, count)) %>% 
    mutate(visit_date = year(visit_date)) %>% 
  rename(id = id_1,
         date = visit_date) %>% 
  filter(visual_animal_state == "alive")


sf_ves <- st_as_sf(clean_ves_data, coords = c('utme', 'utmn'), crs = "+proj=utm +zone=11")

leaf_ves = st_transform(sf_ves, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")


ves <- leaf_ves %>% 
  mutate(long = st_coordinates(.)[,1],
         lat = st_coordinates(.)[,2]) %>% 
  as.data.frame() %>% 
  dplyr::select(!c(geometry)) %>% 
  group_by(id, date, species, visual_life_stage, visual_animal_state, lat, long, ) %>% 
  summarise(count = sum(count))

write_csv(ves, here("data", "ves_data.csv"))


```

# bd_load data
```{r}
bd_data <- read_csv(here("data", "bd.csv")) %>% 
  clean_names()

clean_bd_data <- bd_data %>% 
  dplyr::select(id_1, utme_11, utmn_12, wilderness, visit_date, species, bd_load) %>% 
  mutate(visit_date = year(visit_date)) %>% 
  rename(id = id_1,
         utme = utme_11,
         utmn = utmn_12,
         date = visit_date)

sf_bd <- st_as_sf(clean_bd_data, coords = c('utme', 'utmn'), crs = "+proj=utm +zone=11")

leaf_bd = st_transform(sf_bd, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")


bd <- leaf_bd %>% 
  mutate(long = st_coordinates(.)[,1],
         lat = st_coordinates(.)[,2]) %>% 
  as.data.frame() %>% 
  dplyr::select(!c(geometry)) %>% 
  group_by(id, date, species, lat, long, wilderness) %>% 
  summarise(bd = mean(bd_load))

write_csv(bd, here("data", "bd_data.csv"))

shiny_data <- left_join(bd, ves)

write.csv(shiny_data, here("data", "shiny_data.csv"))

```


```{r}

spec <- shiny_data %>% 
  group_by(id, date) %>% 
  filter(visual_life_stage == "adult")
```


```{r}
sf_ves <- st_as_sf(clean_ves_data, coords = c('utme', 'utmn'), crs = "+proj=utm +zone=11")

leaf_ves = st_transform(sf_ves, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")


coord <- leaf_ves %>% 
  mutate(long = st_coordinates(.)[,1],
         lat = st_coordinates(.)[,2]) %>% 
  as.data.frame() 


```


```{r}

leaf_bd <- clean_bd_data %>% 
  filter(wilderness == "yosemite",
        date == "2019")

leaf_test <- coord %>% 
  filter(wilderness == "yosemite")

leaflet() %>% 
  addProviderTiles("Esri.WorldImagery") %>% 
  addPolygons(data = wilderness_shape)

```

```{r}

yos <- read_sf(here("data", "Yosemite", "yosemite.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

seq <- read_sf(here("data", "seq_king", "Sequoia_Kings_Canyon.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

king <- read_sf(here("data", "seq_king", "Sequoia_Kings_Canyon.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

troot <- read_sf(here("data", "Golden_Trout", "Golden_Trout.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

john <- read_sf(here("data", "John_Muir", "John_Muir.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

hoov <- read_sf(here("data", "Hoover", "Hoover.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

des <- read_sf(here("data", "Desolation", "Desolation.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)



adam <- read_sf(here("data", "Ansel_Adams", "Ansel_Adams.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

wilderness_shape <- bind_rows(yos, seq, king, troot, john, hoov, des, adam)

wild_names <- data.frame(names = c("yosemite", "kings_canyon", "sequoia", "golden_trout", 
                                  "john_muir", "hoover", "desolation", "ansel_adams"))

wilderness_shape <- bind_cols(wilderness_shape, wild_names) %>% 
  select(!c(name))

wilderness_shape = st_transform(wilderness_shape, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")

st_write(wilderness_shape, here("data", "wilderness_shapes", "wilderness.shp"))

```

