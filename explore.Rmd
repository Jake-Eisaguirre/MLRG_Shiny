---
title: "explore"
author: "Jake Eisaguirre"
date: "6/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(janitor)
library(sf)
library(lubridate)
library(leaflet)
library(sp)
library(RPostgreSQL)
library(rstudioapi)
library(DBI)
library(RPostgres)
```

# db connection
```{r}



drv = dbDriver("Postgres")
host = "anura.eri.ucsb.edu"
port = "5432"
dbname = "jake"


tryCatch({
    drv <- dbDriver("Postgres")
    print("Connecting to Databaseâ€¦")
    connection <- dbConnect(drv, 
                 dbname = dbname,
                 host = host, 
                 port = port,
                 user = askForPassword("user name"), 
                 password = askForPassword("password"))
    print("Database Connected!")
    },
    error=function(cond) {
            print("Unable to connect to Database.")
    })




```
# VES sql query
```{sql ves_data, connection=connection, output.var = "ves_data"}

-- script for VES data
select *
from site s 
join visit v on s.id = v.site_id 
join survey s2 on v.id = s2.visit_id 
join visual_survey vs on s2.id = vs.survey_id;


```



# VES data wrangling
```{r}
#ves_data <- read_csv(here("data", "ves.csv")) %>% 
#  clean_names()

clean_ves_data <- ves_data %>% 
  dplyr::select(c(id, utme, utmn, wilderness, visit_date, species, visual_life_stage, 
                  visual_animal_state, count)) %>% 
    mutate(visit_date = year(visit_date)) %>% 
  rename(id = id,
         date = visit_date) %>% 
  filter(visual_animal_state == "alive")


sf_ves <- st_as_sf(clean_ves_data, coords = c('utme', 'utmn'), crs = "+proj=utm +zone=11")

leaf_ves = st_transform(sf_ves, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")


ves <- leaf_ves %>% 
  mutate(long = st_coordinates(.)[,1],
         lat = st_coordinates(.)[,2]) %>% 
  as.data.frame() %>% 
  dplyr::select(!c(geometry)) %>% 
  group_by(id, date, species, visual_life_stage, visual_animal_state, lat, long, ) %>% 
  summarise(count = sum(count))

#write_csv(ves, here("data", "ves_data.csv"))


```

# Bd sql query
```{sql bd_data, connection=connection, output.var = "bd_data"}

-- script of BD load
select *
from site s 
join visit v on s.id = v.site_id 
join survey s2 on v.id = s2.visit_id 
join capture_survey cs on s2.id = cs.survey_id  
join bd_load bl on cs.swab_id = bl.sample_id 



```


# bd_load data
```{r}
# bd_data <- read_csv(here("data", "bd.csv")) %>% 
#   clean_names()

clean_bd_data <- bd_data %>% 
  dplyr::select(id, utme, utmn, wilderness, visit_date, species, bd_load) %>% 
  mutate(visit_date = year(visit_date)) %>% 
  rename(id = id,
         utme = utme,
         utmn = utmn,
         date = visit_date)

sf_bd <- st_as_sf(clean_bd_data, coords = c('utme', 'utmn'), crs = "+proj=utm +zone=11")

leaf_bd = st_transform(sf_bd, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")


bd <- leaf_bd %>% 
  mutate(long = st_coordinates(.)[,1],
         lat = st_coordinates(.)[,2]) %>% 
  as.data.frame() %>% 
  dplyr::select(!c(geometry)) %>% 
  group_by(id, date, species, lat, long, wilderness) %>% 
  summarise(bd = mean(bd_load))

#write_csv(bd, here("data", "bd_data.csv"))

shiny_data <- left_join(bd, ves)

#write.csv(shiny_data, here("data", "shiny_data.csv"))

```


```{r}

spec <- shiny_data %>% 
  group_by(id, date) %>% 
  filter(visual_life_stage == "adult")
```


```{r}
sf_ves <- st_as_sf(clean_ves_data, coords = c('utme', 'utmn'), crs = "+proj=utm +zone=11")

leaf_ves = st_transform(sf_ves, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")


coord <- leaf_ves %>% 
  mutate(long = st_coordinates(.)[,1],
         lat = st_coordinates(.)[,2]) %>% 
  as.data.frame() 


```


```{r}

leaf_bd <- clean_bd_data %>% 
  filter(wilderness == "yosemite",
        date == "2019")

leaf_test <- coord %>% 
  filter(wilderness == "yosemite")

leaflet() %>% 
  addProviderTiles("Esri.WorldImagery") %>% 
  addPolygons(data = wilderness_shape)

```

```{r}

yos <- read_sf(here("data", "Yosemite", "yosemite.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

seq <- read_sf(here("data", "seq_king", "Sequoia_Kings_Canyon.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

king <- read_sf(here("data", "seq_king", "Sequoia_Kings_Canyon.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

troot <- read_sf(here("data", "Golden_Trout", "Golden_Trout.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

john <- read_sf(here("data", "John_Muir", "John_Muir.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

hoov <- read_sf(here("data", "Hoover", "Hoover.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

des <- read_sf(here("data", "Desolation", "Desolation.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)



adam <- read_sf(here("data", "Ansel_Adams", "Ansel_Adams.shp")) %>% 
  select(c(NAME_ABBRE, geometry)) %>% 
  rename(name = NAME_ABBRE)

wilderness_shape <- bind_rows(yos, seq, king, troot, john, hoov, des, adam)

wild_names <- data.frame(names = c("yosemite", "kings_canyon", "sequoia", "golden_trout", 
                                  "john_muir", "hoover", "desolation", "ansel_adams"))

wilderness_shape <- bind_cols(wilderness_shape, wild_names) %>% 
  select(!c(name))

wilderness_shape = st_transform(wilderness_shape, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")

st_write(wilderness_shape, here("data", "wilderness_shapes", "wilderness.shp"))

```

